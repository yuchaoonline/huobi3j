(function(){isc.util.namespace("isc.ui.control");isc.ui.control.SyncSelector=d;var a=isc.util;var f=a.extend;var e=a.format;var c=isc.data.cascade.CascadeData;var b={render:function(){},selectItem:function(g,h){},getSelectedItem:function(){return null}};function d(g,k,i,j){var h={};f(b,h);h.option={defaultValue:-1,defaultText:"请选择",containers:[document.body]};f(j,h.option);h.dataContext=g;h.controls=[];h.id=k;h.names=i;h.selectedDataItem=null;h.selectedText=null;h.selectedValue=null;h.events={};h.bindEvent=function(l,m,n){this.events[l]={fn:m,data:n}};h.trigger=function(l,m){if(this.events[l]&&this.events[l].fn){this.events[l].fn.call(this,m,this.events[l].data)}};h.render=function(){for(var q=0;q<this.names.length;q++){var l=this.names[q];var p=jQuery(e('<select id="{0}" name="{1}" depth="{2}"></select>',(k+"_"+l),l,q));this.controls.push({name:l,selector:p,selectedItem:null})}this.selectedText=jQuery(e('<input type="hidden" name="{0}" id="{0}" />',this.id+"_text"));this.selectedValue=jQuery(e('<input type="hidden" name="{0}" id="{0}" />',this.id+"_value"));var n=$("form:first"),m=n.width()==null?$(document.body):n;if(n.width()==null){}this.selectedText.appendTo(m);this.selectedValue.appendTo(m);if(this.controls.length==0){return}for(var q=0;q<this.controls.length;q++){var t=this.controls[q];var r=this.controls[q+1];if(r==null){this._onSelectorChange(t,null)}else{this._onSelectorChange(t,r)}}var s=this.dataContext.getItem("",{startDepth:0,endDepth:0});this._bindData(s,this.controls[0].selector);for(var q=1;q<this.controls.length;q++){this._bindData(null,this.controls[q].selector)}var o=this.option.containers;if(o.length!=this.controls.length){var m=jQuery(o[0]);for(var q=0;q<this.controls.length;q++){this.controls[q].selector.appendTo(m)}}else{for(var q=0;q<o.length;q++){this.controls[q].selector.appendTo(jQuery(o[q]))}}this._refreshPostData();this.trigger("onRendered",this)};h._bindData=function(l,q){if(q==null){return}var o=[];o.push(e("<option value='{0}'>{1}</option>",this.option.defaultValue,this.option.defaultText));if(l==null){q.html(o.join(""));return}for(var n=0;n<l.attachedItems.length;n++){var p=l.attachedItems[n];if(p==null){break}var m=e("<option value='{0}'>{1}</option>",p.key,p.value);o.push(m)}q.html(o.join("\r\n"))};h._onSelectorChange=function(l,m){l.selector.bind("change",{syncSelector:this,current:l,next:m},function(r){var q=r.data.syncSelector,p=r.data.current,u=r.data.next;var o=$(this),s=parseInt(o.attr("depth")),t=o.val(),n=t==null?null:q.dataContext.getItem(t,{startDepth:s,endDepth:s});if(u){if(n==null){q._bindData(null,u.selector)}else{q._bindData(n.childs(),u.selector)}}p.selectedItem=n;q._refreshPostData();q.trigger("selectorChanged",p);if(u){u.selector.trigger("change")}else{q.trigger("valueChanged",q.selectedDataItem)}})};h._refreshPostData=function(){var p=[];var n=[];var l=false;for(var o=0;o<this.controls.length;o++){var m=this.controls[o].selectedItem;if(m==null){p.push(this.option.defaultValue);n.push(this.option.defaultText)}else{l=true;p.push(m.key);n.push(m.value);this.selectedDataItem=m}}var r=p.join(","),q=n.join(",");this.selectedValue.val(r);this.selectedText.val(q);if(!l){this.selectedDataItem=null}};h.getControl=function(m){if(a.isNumber(m)){return this.controls[m]}for(var l=0;l<this.controls.length;l++){if(this.controls[l].name==m){return this.controls[l]}}};h.getValues=function(){return this.selectedValue.val()};h.getTexts=function(){return this.selectedText.val()};h.getSelectedItem=function(){return this.selectedDataItem};h.selectItem=function(m,r){var l=this.dataContext.getItem(m,r);if(l==null){return}if(l.depth==0&&(l.attachedItems.length==0||l.attachedItems.length==1)){var p=this.getControl(0).selector;p.val(l.key);p.trigger("change");return}var o=[];if(l.attachedItems.length>1){for(var q=0;q<l.attachedItems.length;q++){if(l.attachedItems[q]==null){break}else{o.push(l.attachedItems[q])}}}else{o.push(l);var t=l.parent();while(t!=null){o.push(t);t=t.parent()}}o.sort(function(v,u){if(v.depth<u.depth){return -1}return 1});if(o[0].depth!=0){return}for(var q=0;q<o.length;q++){var n=this.getControl(q);n.selectedItem=o[q];if(n!=null){var s=this.dataContext.getItem("path:"+n.selectedItem.parentPath,{startDepth:q,endDepth:q});this._bindData(s,n.selector,n);n.selector.val(n.selectedItem.key)}}this.getControl(o.length-1).selector.trigger("change");this._refreshPostData()};f(h,this)}})();